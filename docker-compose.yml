version: '3.8'
services:
  desktop:
    image: elestio/ubuntu_desktop:${SOFTWARE_VERSION_TAG}
    restart: always
    dns:
      - 8.8.8.8
    ports:
      - "172.17.0.1:6901:6901"
      - "172.17.0.1:4901:4901"
    volumes:
      - /data:/home/kasm-user
      - ./scripts/vnc_startup.sh:/dockerstartup/vnc_startup.sh
      - ./data-src/jsmpeg:/dockerstartup/jsmpeg
      - ./data-src/jsmpeg/injectaudio.js:/usr/share/kasmvnc/www/dist/style.bundle.js
      - ./data-src/jsmpeg/jsmpeg.min.js:/usr/share/kasmvnc/www/dist/jsmpeg.min.js
      - ./data-src/jsmpeg/audio.html:/usr/share/kasmvnc/www/dist/audio.html
      # Share the X socket directory so another container can draw on the desktop
      - x11-sock:/tmp/.X11-unix
    shm_size: "512m"
    environment:
      VNC_USER: ${ADMIN_LOGIN}
      VNC_PW: ${ADMIN_PASSWORD}
  db:
    image: ankane/pgvector:latest
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: tomo
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
  computer-use-mcp:
    build:
      context: .
      dockerfile: docker/computer-use-mcp/Dockerfile
    environment:
      DISPLAY: ${DISPLAY}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
    network_mode: host
    stdin_open: true
    tty: true
  ur3_sim:
    build:
      context: ./ur3_test
      dockerfile: docker/Dockerfile
    image: ur3_pick_place:jazzy
    container_name: ur3_sim_test
    network_mode: host
    ipc: host
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - GZ_SIM_RESOURCE_PATH=/ws/install/ur_description/share:/ws/install/robotiq_2f_85_gripper_visualization/share:/ws/install
      - IGN_GAZEBO_RESOURCE_PATH=/ws/install/ur_description/share:/ws/install/robotiq_2f_85_gripper_visualization/share:/ws/install
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev/dri:/dev/dri
    stdin_open: true
    tty: true

volumes:
  db-data:
  x11-sock:
